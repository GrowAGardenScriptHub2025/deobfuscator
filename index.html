<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lua Deobfuscator Enhanced</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  <style>
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animate-slide-in {
      animation: slideIn 0.5s ease-out forwards;
    }
    .editor {
      height: 300px;
      width: 100%;
      border-radius: 0.5rem;
      border: 1px solid #4b5563;
      background-color: #1f2937;
      color: #d1d5db;
    }
    .log-entry {
      transition: all 0.3s ease;
    }
    .log-entry:hover {
      background-color: #374151;
    }
    .card {
      background-color: #2d3748;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="container mx-auto max-w-6xl">
    <h1 class="text-3xl font-bold text-center mb-6 animate-slide-in">Lua Deobfuscator Enhanced</h1>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Input Section -->
      <div class="card animate-slide-in" style="animation-delay: 0.1s;">
        <h2 class="text-xl font-semibold mb-2">Input Payload</h2>
        <p class="text-gray-400 mb-4 text-sm">Paste your obfuscated Lua script or encoded payload here</p>
        <div id="inputEditor" class="editor"></div>
        <button id="decodeBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg mt-4 w-full transition duration-300 flex items-center justify-center">
          <span class="mr-2">üîç</span> Decode Payload
        </button>
      </div>
      <!-- Output Section -->
      <div class="card animate-slide-in" style="animation-delay: 0.2s;">
        <h2 class="text-xl font-semibold mb-2">Decoded Output</h2>
        <p class="text-gray-400 mb-4 text-sm">Reconstructed Lua script will appear here...</p>
        <div id="outputEditor" class="editor"></div>
      </div>
    </div>
    <!-- Decoding Process Section -->
    <div class="card animate-slide-in" style="animation-delay: 0.3s;">
      <h2 class="text-xl font-semibold mb-2">Decoding Process</h2>
      <p class="text-gray-400 mb-4 text-sm">Step-by-step breakdown of the decoding process</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <h3 class="text-md font-medium mb-2">Decoding Steps</h3>
          <div id="logs" class="bg-gray-800 p-2 rounded-lg h-32 overflow-y-auto text-sm"></div>
        </div>
        <div>
          <h3 class="text-md font-medium mb-2">Extracted URLs</h3>
          <div id="urlList" class="bg-gray-800 p-2 rounded-lg h-32 overflow-y-auto text-sm text-gray-400"></div>
        </div>
        <div>
          <h3 class="text-md font-medium mb-2">Tool Information</h3>
          <div class="bg-gray-800 p-2 rounded-lg h-32 overflow-y-auto text-sm text-gray-400">
            <p><strong>Supported Patterns:</strong></p>
            <ul class="list-disc list-inside text-sm">
              <li>LOL! ... - Custom encoded payloads</li>
              <li>\x## - Hexadecimal escape sequences</li>
              <li>\### - Octal escape sequences</li>
              <li>string.char() - Character code functions</li>
              <li>XOR encoded data</li>
              <li>String encryption XOR key 0x10</li>
              <li>String splitting + table.concat</li>
              <li>Dynamic code execution via loadstring/load</li>
              <li>Junk code detection and removal</li>
              <li>Control flow wrapper unwrapping</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize ACE editors
    const inputEditor = ace.edit("inputEditor");
    inputEditor.setTheme("ace/theme/monokai");
    inputEditor.session.setMode("ace/mode/lua");
    inputEditor.setOptions({ fontSize: "14px" });

    const outputEditor = ace.edit("outputEditor");
    outputEditor.setTheme("ace/theme/monokai");
    outputEditor.session.setMode("ace/mode/lua");
    outputEditor.setOptions({ fontSize: "14px", readOnly: true });

    // Utility: Decode escaped sequences to raw string
    function decodeEscapes(str) {
      return str
        .replace(/\\x([0-9A-Fa-f]{2})/g, (_, hex) => String.fromCharCode(parseInt(hex, 16)))
        .replace(/\\(\d{1,3})/g, (_, dec) => String.fromCharCode(parseInt(dec, 10)));
    }

    // XOR decode with key 0x10
    function decodeXorKey16(code, logs) {
      const xorRegex = /"(\\x[0-9A-Fa-f]{2}|\\\d{1,3}|[^"\\])*"/g;
      return code.replace(xorRegex, (match) => {
        let str = match.slice(1, -1);
        str = decodeEscapes(str);
        let decoded = '';
        for (let i = 0; i < str.length; i++) {
          decoded += String.fromCharCode(str.charCodeAt(i) ^ 16);
        }
        logs.push(`XOR-decoded string with key 0x10: "${decoded}"`);
        return `"${decoded}"`;
      });
    }

    // Reassemble string arrays e.g. {'h','t','t','p'} + table.concat(...)
    function decodeStringArrayConcat(code, logs) {
      // Pattern: local var = {'h','t','t','p'}; var = table.concat(var)
      const arrRegex = /(\w+)\s*=\s*\{((?:'[^']',?\s*)+)\};?\s*\1\s*=\s*table\.concat\(\s*\1\s*\)/g;
      let replaced = code.replace(arrRegex, (match, varName, chars) => {
        const arr = chars.match(/'([^'])'/g).map(s => s[1]);
        const str = arr.join('');
        logs.push(`Reassembled string array '${varName}' to "${str}"`);
        return `${varName} = "${str}"`;
      });

      // Inline concat: table.concat({'h','t','t','p'})
      const inlineConcatRegex = /table\.concat\(\s*\{((?:'[^']',?\s*)+)\}\s*\)/g;
      replaced = replaced.replace(inlineConcatRegex, (match, chars) => {
        const arr = chars.match(/'([^'])'/g).map(s => s[1]);
        const str = arr.join('');
        logs.push(`Reassembled inline table.concat string to "${str}"`);
        return `"${str}"`;
      });

      return replaced;
    }

    // Decode loadstring/load dynamic code execution
    function decodeLoadstring(code, logs) {
      const loadRegex = /(loadstring|load)\(\s*"(.*?)"\s*\)/gs;
      return code.replace(loadRegex, (match, func, payload) => {
        let decodedPayload = decodeEscapes(payload)
          .replace(/\\n/g, '\n')
          .replace(/\\"/g, '"')
          .replace(/\\\\/g, '\\');

        logs.push(`Decoded ${func} string payload:\n${decodedPayload.trim().slice(0, 100)}${decodedPayload.length > 100 ? '...' : ''}`);

        return `-- Decoded dynamic code start --\n${decodedPayload}\n-- Decoded dynamic code end --`;
      });
    }

    // Remove junk code patterns
    function removeJunkCode(code, logs) {
      const junkFuncRegex = /local\s+_\w+\s*=\s*function\s*\([^)]*\)[\s\S]*?end\s*/g;
      const cleaned = code.replace(junkFuncRegex, (match) => {
        logs.push("Removed junk math function");
        return '';
      });

      if (/if\s+_\w+\s*>\s*40/.test(cleaned)) {
        logs.push("Detected always-true conditional (ignored)");
      }

      if (/while\s+_\w+\s*<\s*50\s*do/.test(cleaned)) {
        logs.push("Detected unused loop (ignored)");
      }

      return cleaned;
    }

    // Unwrap trivial control flow wrappers
    function unwrapControlFlow(code, logs) {
      const wrapperRegex = /local\s+_\w+\s*=\s*function\s*\(\)\s*([\s\S]+?)\s*end;\s*_\w+\(\)/g;
      let count = 0;
      return code.replace(wrapperRegex, (match, innerCode) => {
        count++;
        logs.push(`Unwrapped control flow wrapper function #${count}`);
        return innerCode.trim();
      });
    }

    // Main deobfuscate function
    function deobfuscate(code) {
      const logs = [];
      let deobfuscated = code;

      try {
        // Basic hex & octal decoding
        deobfuscated = deobfuscated.replace(/\\x([0-9A-Fa-f]{2})/g, (m, h) => {
          logs.push(`Decoded hex \\x${h}`);
          return String.fromCharCode(parseInt(h, 16));
        });
        deobfuscated = deobfuscated.replace(/\\(\d{1,3})/g, (m, o) => {
          logs.push(`Decoded octal \\${o}`);
          return String.fromCharCode(parseInt(o, 8));
        });

        // string.char decoding (basic)
        deobfuscated = deobfuscated.replace(/string\.char\(([\d,\s]+)\)/g, (m, nums) => {
          const chars = nums.split(',').map(n => String.fromCharCode(parseInt(n.trim()))).join('');
          logs.push(`Decoded string.char to "${chars}"`);
          return `"${chars}"`;
        });

        // Remove junk code
        deobfuscated = removeJunkCode(deobfuscated, logs);

        // Unwrap control flow wrappers
        deobfuscated = unwrapControlFlow(deobfuscated, logs);

        // XOR decode key=0x10
        deobfuscated = decodeXorKey16(deobfuscated, logs);

        // Reassemble string arrays + table.concat
        deobfuscated = decodeStringArrayConcat(deobfuscated, logs);

        // Decode loadstring/load dynamic code
        deobfuscated = decodeLoadstring(deobfuscated, logs);

        // Extract URLs
        const urlRegex = /https?:\/\/[^\s'"]+/g;
        const urls = deobfuscated.match(urlRegex) || [];

        // Basic formatting
        const lines = deobfuscated.split("\n");
        let indentLevel = 0;
        deobfuscated = lines.map(line => {
          line = line.trim();
          if (line.match(/end$/)) indentLevel = Math.max(0, indentLevel - 1);
          const indented = "  ".repeat(indentLevel) + line;
          if (line.match(/do$|then$|function/)) indentLevel++;
          return indented;
        }).join("\n");
        logs.push("Applied basic code formatting");

        return { deobfuscated, logs, urls };
      } catch (e) {
        logs.push(`Error during deobfuscation: ${e.message}`);
        return { deobfuscated, logs, urls: [] };
      }
    }

    // Update logs UI
    function updateLogs(logs) {
      const logsDiv = document.getElementById("logs");
      logsDiv.innerHTML = logs.length
        ? logs.map(log => `<div class="log-entry p-1">${log}</div>`).join("")
        : "<div class='p-1 text-gray-500'>No decoding steps yet. Enter a payload and click decode.</div>";
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    // Update URLs UI
    function updateUrls(urls) {
      const urlList = document.getElementById("urlList");
      urlList.innerHTML = urls.length
        ? urls.map(url => `<div class="p-1"><a href="${url}" target="_blank" class="text-blue-400 hover:underline">${url}</a></div>`).join("")
        : "<div class='p-1 text-gray-500'>No URLs extracted.</div>";
    }

    // Button click handler
    document.getElementById("decodeBtn").addEventListener("click", () => {
      const inputCode = inputEditor.getValue().trim();
      if (!inputCode) {
        updateLogs(["No input code provided"]);
        updateUrls([]);
        return;
      }
      const { deobfuscated, logs, urls } = deobfuscate(inputCode);
      outputEditor.setValue(deobfuscated, -1);
      updateLogs(logs);
      updateUrls(urls);
    });
  </script>
</body>
</html>
