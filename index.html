<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lua Deobfuscator Enhanced</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  <style>
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
    .editor {
      height: 300px;
      width: 100%;
      border-radius: 0.5rem;
      border: 1px solid #4b5563;
      background-color: #1f2937;
      color: #d1d5db;
    }
    .log-entry {
      transition: all 0.3s ease;
    }
    .log-entry:hover {
      background-color: #374151;
    }
    .card {
      background-color: #2d3748;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #warningBox {
      background-color: #b91c1c;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
      font-weight: bold;
      display: none;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="container mx-auto max-w-6xl">
    <h1 class="text-3xl font-bold text-center mb-6 animate-slide-in">Lua Deobfuscator Enhanced</h1>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-4">
      <div class="card animate-slide-in" style="animation-delay: 0.1s;">
        <h2 class="text-xl font-semibold mb-2">Input Payload</h2>
        <p class="text-gray-400 mb-4 text-sm">Paste your obfuscated Lua script or encoded payload here</p>
        <div id="inputEditor" class="editor"></div>
        <button id="decodeBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg mt-4 w-full transition duration-300 flex items-center justify-center">
          <span class="mr-2">üîç</span> Decode Payload
        </button>
        <button id="downloadBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg mt-4 w-full transition duration-300 flex items-center justify-center" disabled>
          üíæ Download Deobfuscated Code
        </button>
        <div id="warningBox"></div>
      </div>
      <div class="card animate-slide-in" style="animation-delay: 0.2s;">
        <h2 class="text-xl font-semibold mb-2">Decoded Output</h2>
        <p class="text-gray-400 mb-4 text-sm">Reconstructed Lua script will appear here...</p>
        <div id="outputEditor" class="editor"></div>
      </div>
    </div>
    <div class="card animate-slide-in" style="animation-delay: 0.3s;">
      <h2 class="text-xl font-semibold mb-2">Decoding Process</h2>
      <p class="text-gray-400 mb-4 text-sm">Step-by-step breakdown of the decoding process</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <h3 class="text-md font-medium mb-2">Decoding Steps</h3>
          <div id="logs" class="bg-gray-800 p-2 rounded-lg h-32 overflow-y-auto text-sm"></div>
        </div>
        <div>
          <h3 class="text-md font-medium mb-2">Extracted URLs</h3>
          <div id="urlList" class="bg-gray-800 p-2 rounded-lg h-32 overflow-y-auto text-sm text-gray-400"></div>
        </div>
        <div>
          <h3 class="text-md font-medium mb-2">Tool Information</h3>
          <div class="bg-gray-800 p-2 rounded-lg h-64 overflow-y-auto text-sm text-gray-400">
            <p><strong>Supported Patterns & How They‚Äôre Decoded:</strong></p>
            <ul class="list-disc list-inside space-y-1">
              <li><strong>\x## / \###:</strong> Hex & octal escape decoding</li>
              <li><strong>string.char(...):</strong> Converted to plain strings</li>
              <li><strong>XOR key 0x10:</strong> XOR-decoded payloads</li>
              <li><strong>table.concat({}):</strong> Reassembled strings</li>
              <li><strong>Base64:</strong> Decoded where detected</li>
              <li><strong>loadstring():</strong> Decoded and unwrapped (recursive)</li>
              <li><strong>Junk code:</strong> Removed dummy functions</li>
              <li><strong>Control flow wrappers:</strong> Unwrapped</li>
              <li><strong>URLs:</strong> Auto-extracted from payload</li>
              <li><strong>Malicious pattern detection:</strong> Discord webhooks & suspicious HTTPGet</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const inputEditor = ace.edit("inputEditor");
    inputEditor.setTheme("ace/theme/monokai");
    inputEditor.session.setMode("ace/mode/lua");
    inputEditor.setOptions({ fontSize: "14px" });

    const outputEditor = ace.edit("outputEditor");
    outputEditor.setTheme("ace/theme/monokai");
    outputEditor.session.setMode("ace/mode/lua");
    outputEditor.setOptions({ fontSize: "14px", readOnly: true });

    function decodeEscapes(str) {
      return str
        .replace(/\\x([0-9A-Fa-f]{2})/g, (_, hex) => String.fromCharCode(parseInt(hex, 16)))
        .replace(/\\(\d{1,3})/g, (_, dec) => String.fromCharCode(parseInt(dec, 10)));
    }

    function decodeXorKey16(code, logs) {
      const xorRegex = /"(\\x[0-9A-Fa-f]{2}|\\\d{1,3}|[^"\\])*"/g;
      return code.replace(xorRegex, (match) => {
        let str = match.slice(1, -1);
        str = decodeEscapes(str);
        let decoded = '';
        for (let i = 0; i < str.length; i++) {
          decoded += String.fromCharCode(str.charCodeAt(i) ^ 16);
        }
        logs.push(`XOR-decoded string with key 0x10: "${decoded}"`);
        return `"${decoded}"`;
      });
    }

    function decodeStringArrayConcat(code, logs) {
      const arrRegex = /(\w+)\s*=\s*\{((?:'[^']',?\s*)+)\};?\s*\1\s*=\s*table\.concat\(\s*\1\s*\)/g;
      let replaced = code.replace(arrRegex, (match, varName, chars) => {
        const arr = chars.match(/'([^'])'/g).map(s => s[1]);
        const str = arr.join('');
        logs.push(`Reassembled array '${varName}' to "${str}"`);
        return `${varName} = "${str}"`;
      });

      const inlineConcatRegex = /table\.concat\(\s*\{((?:'[^']',?\s*)+)\}\s*\)/g;
      replaced = replaced.replace(inlineConcatRegex, (match, chars) => {
        const arr = chars.match(/'([^'])'/g).map(s => s[1]);
        const str = arr.join('');
        logs.push(`Flattened table.concat to "${str}"`);
        return `"${str}"`;
      });

      return replaced;
    }

    function decodeLoadstring(code, logs) {
      // Recursively decode nested loadstring/load calls
      let depth = 0;
      const maxDepth = 10; // avoid infinite loops
      let currentCode = code;

      while (depth < maxDepth) {
        let changed = false;
        currentCode = currentCode.replace(/(loadstring|load)\(\s*"(.*?)"\s*\)/gs, (match, func, payload) => {
          let decodedPayload = decodeEscapes(payload)
            .replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
          logs.push(`Decoded ${func} payload at recursion depth ${depth + 1}`);
          changed = true;
          return `-- Decoded dynamic code start --\n${decodedPayload}\n-- Decoded dynamic code end --`;
        });
        if (!changed) break;
        depth++;
      }
      if (depth === maxDepth) logs.push("Max recursion depth reached for loadstring decoding");
      return currentCode;
    }

    function removeJunkCode(code, logs) {
      const junkFuncRegex = /local\s+_\w+\s*=\s*function\s*\([^)]*\)[\s\S]*?end\s*/g;
      const cleaned = code.replace(junkFuncRegex, () => {
        logs.push("Removed junk math function");
        return '';
      });
      return cleaned;
    }

    function unwrapControlFlow(code, logs) {
      const wrapperRegex = /local\s+_\w+\s*=\s*function\s*\(\)\s*([\s\S]+?)\s*end;\s*_\w+\(\)/g;
      let count = 0;
      return code.replace(wrapperRegex, (_, innerCode) => {
        count++;
        logs.push(`Unwrapped control flow wrapper function #${count}`);
        return innerCode.trim();
      });
    }

    function base64Decode(code, logs) {
      const b64Regex = /"([A-Za-z0-9+/=]{20,})"/g;
      return code.replace(b64Regex, (match, b64) => {
        try {
          const decoded = atob(b64);
          logs.push(`Base64-decoded string snippet: "${decoded.slice(0, 50)}..."`);
          return `"${decoded}"`;
        } catch {
          return match;
        }
      });
    }

    // Malicious pattern detection
    function detectMaliciousPatterns(code) {
      const warnings = [];
      // Detect Discord webhook URLs
      const webhookRegex = /https:\/\/discord(?:app)?\.com\/api\/webhooks\/\d+\/[A-Za-z0-9_-]+/g;
      if (webhookRegex.test(code)) warnings.push("‚ö†Ô∏è Discord webhook URL detected");

      // Detect suspicious HttpGet or HttpRequest from suspicious URLs
      const suspiciousHttpGet = /(game|syn|http)\:Http(Get|Request).*(pastebin\.com|hastebin\.com|ghostbin\.com|anonfiles\.com)/gi;
      if (suspiciousHttpGet.test(code)) warnings.push("‚ö†Ô∏è Suspicious HttpGet/HttpRequest from pastebin-like URL detected");

      return warnings;
    }

    function deobfuscate(code) {
      const logs = [];
      let deobfuscated = code;

      try {
        deobfuscated = deobfuscated.replace(/\\x([0-9A-Fa-f]{2})/g, (m, h) => {
          logs.push(`Hex \\x${h} ‚Üí '${String.fromCharCode(parseInt(h, 16))}'`);
          return String.fromCharCode(parseInt(h, 16));
        });

        deobfuscated = deobfuscated.replace(/\\(\d{1,3})/g, (m, o) => {
          logs.push(`Octal \\${o} ‚Üí '${String.fromCharCode(parseInt(o, 8))}'`);
          return String.fromCharCode(parseInt(o, 8));
        });

        deobfuscated = deobfuscated.replace(/string\.char\(([\d,\s]+)\)/g, (m, nums) => {
          const chars = nums.split(',').map(n => String.fromCharCode(parseInt(n.trim()))).join('');
          logs.push(`string.char ‚Üí "${chars}"`);
          return `"${chars}"`;
        });

        deobfuscated = removeJunkCode(deobfuscated, logs);
        deobfuscated = unwrapControlFlow(deobfuscated, logs);
        deobfuscated = decodeXorKey16(deobfuscated, logs);
        deobfuscated = decodeStringArrayConcat(deobfuscated, logs);
        deobfuscated = decodeLoadstring(deobfuscated, logs);
        deobfuscated = base64Decode(deobfuscated, logs);

        const urlRegex = /https?:\/\/[^\s'"]+/g;
        const urls = deobfuscated.match(urlRegex) || [];

        const lines = deobfuscated.split("\n");
        let indentLevel = 0;
        deobfuscated = lines.map(line => {
          line = line.trim();
          if (line.match(/end$/)) indentLevel = Math.max(0, indentLevel - 1);
          const indented = "  ".repeat(indentLevel) + line;
          if (line.match(/do$|then$|function/)) indentLevel++;
          return indented;
        }).join("\n");

        logs.push("Formatted code structure");

        return { deobfuscated, logs, urls };
      } catch (e) {
        logs.push(`Error: ${e.message}`);
        return { deobfuscated, logs, urls: [] };
      }
    }

    function updateLogs(logs) {
      const logsDiv = document.getElementById("logs");
      logsDiv.innerHTML = logs.length
        ? logs.map(log => `<div class="log-entry p-1">${log}</div>`).join("")
        : "<div class='p-1 text-gray-500'>No logs</div>";
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    function updateUrls(urls) {
      const urlList = document.getElementById("urlList");
      urlList.innerHTML = urls.length
        ? urls.map(url => `<div class="p-1"><a href="${url}" target="_blank" class="text-blue-400 hover:underline">${url}</a></div>`).join("")
        : "<div class='p-1 text-gray-500'>No URLs found</div>";
    }

    function updateWarnings(warnings) {
      const warningBox = document.getElementById("warningBox");
      if (warnings.length === 0) {
        warningBox.style.display = "none";
        warningBox.textContent = "";
      } else {
        warningBox.style.display = "block";
        warningBox.innerHTML = warnings.map(w => `<div>${w}</div>`).join("");
      }
    }

    document.getElementById("decodeBtn").addEventListener("click", () => {
      const inputCode = inputEditor.getValue().trim();
      if (!inputCode) {
        updateLogs(["No input code provided"]);
        updateUrls([]);
        updateWarnings([]);
        document.getElementById("downloadBtn").disabled = true;
        outputEditor.setValue("", -1);
        return;
      }
      const { deobfuscated, logs, urls } = deobfuscate(inputCode);
      outputEditor.setValue(deobfuscated, -1);
      updateLogs(logs);
      updateUrls(urls);

      const warnings = detectMaliciousPatterns(deobfuscated);
      updateWarnings(warnings);

      document.getElementById("downloadBtn").disabled = false;
    });

    document.getElementById("downloadBtn").addEventListener("click", () => {
      const content = outputEditor.getValue();
      if (!content) return;
      const blob = new Blob([content], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'deobfuscated.lua';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
